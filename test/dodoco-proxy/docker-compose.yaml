%YAML 1.2
# -*- coding: UTF-8, tab-width: 2 -*-
---

version: '2.2'

services:

  app_main:
    build:
      context: .
    restart: 'no'
    environment:
      - http_proxy
      - https_proxy
    command: '/envdump.sh main'
    depends_on:
      app_init:
        condition: service_healthy
        # ^-- b/c compose file format v2.2. doesn't yet support
        #     service_completed_successfully

  app_init:
    build:
      context: .
    restart: 'no'
    environment:
      - HTTP_PROXY
      - HTTPS_PROXY
      - |
          EVAL_AFTER=
          /slow_init.sh
    command: '/envdump.sh init'
    healthcheck:
      test: ['CMD', 'test', '-f', '/tmp/healthy']
      interval: 1s
      timeout: 1m
      retries: 9002

...
